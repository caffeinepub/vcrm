{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 33,
  "summary": "Building VCRM — a web-based CRM application using React + TypeScript with Motoko canister backend on the Internet Computer. Features include login/signup via Internet Identity, dashboard with leads/deals/revenue, lead and customer management, follow-up reminders, deal pipeline, search/filter, admin panel, dark/light mode, blue professional theme, and solar project management features (site survey, system size in kW, installation status, customer location map).",
  "architectural_notes": [
    "Frontend: React + TypeScript, Tailwind CSS, mobile-responsive",
    "Backend: Motoko canister on Internet Computer blockchain",
    "Auth: Internet Identity (passkeys, Google, Apple, Microsoft)",
    "Color theme: Blue-based professional, supports dark/light mode"
  ],
  "known_issues": [
    "Session expiry error shown to users: 'Your session may have expired. Please log out and log in again.'",
    "Authentication failed error: 'Authentication failed. Please log out and log in again.' shown unexpectedly to users with valid sessions.",
    "Profile Setup modal shows 'Unable to save profile. Please try again.' error when user submits name and email after Internet Identity login."
  ],
  "isFixRequest": false,
  "existing_features": [
    {
      "id": "feature-implement-internet-identity-based-login-and-signup-so-users-can-authenticate-securely-before-accessing-the-app",
      "title": "Implement Internet Identity-based login and signup so users can authenticate securely before accessing the app.",
      "reqIds": [
        "REQ-1"
      ],
      "version": 1
    },
    {
      "id": "feature-build-a-dashboard-home-screen-displaying-summary-statistics-total-leads-total-deals-and-total-revenue-include-cards-and-charts-for-quick-visual-overview",
      "title": "Build a dashboard home screen displaying summary statistics: total leads, total deals, and total revenue. Include cards and charts for quick visual overview.",
      "reqIds": [
        "REQ-2"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-full-add-edit-and-delete-functionality-for-leads-storing-lead-records-name-contact-status-notes-in-the-motoko-backend",
      "title": "Implement full Add, Edit, and Delete functionality for Leads, storing lead records (name, contact, status, notes) in the Motoko backend.",
      "reqIds": [
        "REQ-3"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-a-customer-management-module-where-customers-can-be-created-viewed-edited-and-deleted-with-fields-for-name-email-phone-and-address",
      "title": "Implement a Customer management module where customers can be created, viewed, edited, and deleted, with fields for name, email, phone, and address.",
      "reqIds": [
        "REQ-4"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-follow-up-reminders-users-can-set-a-reminder-date-and-note-for-any-lead-or-customer-and-overdue-reminders-are-visually-highlighted-in-the-ui",
      "title": "Implement follow-up reminders: users can set a reminder date and note for any lead or customer, and overdue reminders are visually highlighted in the UI.",
      "reqIds": [
        "REQ-5"
      ],
      "version": 1
    },
    {
      "id": "feature-build-a-deal-pipeline-board-with-four-stages-new-in-progress-won-lost-deals-can-be-moved-between-stages-and-each-deal-shows-title-value-and-associated-customer",
      "title": "Build a deal pipeline board with four stages: New, In Progress, Won, Lost. Deals can be moved between stages and each deal shows title, value, and associated customer.",
      "reqIds": [
        "REQ-6"
      ],
      "version": 1
    },
    {
      "id": "feature-add-global-search-and-filter-functionality-across-leads-customers-and-deals-by-name-status-or-date-range",
      "title": "Add global search and filter functionality across leads, customers, and deals by name, status, or date range.",
      "reqIds": [
        "REQ-7"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-an-admin-panel-accessible-only-to-designated-admin-users-showing-user-management-list-of-users-ability-to-toggle-admin-role-and-system-wide-statistics",
      "title": "Implement an Admin panel accessible only to designated admin users, showing user management (list of users, ability to toggle admin role) and system-wide statistics.",
      "reqIds": [
        "REQ-8"
      ],
      "version": 1
    },
    {
      "id": "feature-implement-a-dark-light-mode-toggle-that-persists-the-user-s-preference-and-applies-consistently-across-all-pages",
      "title": "Implement a Dark/Light mode toggle that persists the user's preference and applies consistently across all pages.",
      "reqIds": [
        "REQ-9"
      ],
      "version": 1
    },
    {
      "id": "feature-add-a-solar-projects-module-linked-to-customers-each-solar-project-record-must-include-site-survey-details-notes-date-surveyor-name-system-size-in-kw-installation-status-pending-in-progress-completed-on-hold-and-customer-location-displayed-on-an-embedded-static-map-widget-using-latitude-longitude-coordinates",
      "title": "Add a Solar Projects module linked to customers. Each solar project record must include: site survey details (notes, date, surveyor name), system size in kW, installation status (Pending, In Progress, Completed, On Hold), and customer location displayed on an embedded static map widget using latitude/longitude coordinates.",
      "reqIds": [
        "REQ-10"
      ],
      "version": 1
    },
    {
      "id": "feature-apply-a-professional-blue-based-visual-theme-inspired-by-the-vcrm-logo-deep-blues-white-with-orange-accent-highlights-use-consistent-typography-card-based-layouts-and-a-sidebar-navigation-display-the-vcrm-logo-in-the-sidebar-header-and-login-screen",
      "title": "Apply a professional blue-based visual theme inspired by the VCRM logo (deep blues, white, with orange accent highlights). Use consistent typography, card-based layouts, and a sidebar navigation. Display the VCRM logo in the sidebar header and login screen.",
      "reqIds": [
        "REQ-11"
      ],
      "version": 1
    },
    {
      "id": "feature-display-the-uploaded-vcrm-logo-image-blue-v-with-bar-chart-orange-sphere-accent-silver-crm-text-in-the-sidebar-header-and-on-the-login-page-save-the-logo-as-a-static-asset-at-frontend-public-assets-generated-vcrm-logo-png-and-render-it-in-those-locations",
      "title": "Display the uploaded VCRM logo image (blue V with bar chart, orange sphere accent, silver 'CRM' text) in the sidebar header and on the login page. Save the logo as a static asset at frontend/public/assets/generated/vcrm-logo.png and render it in those locations.",
      "reqIds": [
        "REQ-13"
      ],
      "version": 1
    },
    {
      "id": "feature-on-the-frontend-after-a-user-logs-in-via-internet-identity-check-whether-the-user-s-profile-has-admin-role-and-approved-status-before-rendering-the-access-pending-screen-if-the-user-is-the-first-user-auto-admin-redirect-them-directly-to-the-dashboard-without-displaying-the-access-pending-or-approval-request-ui",
      "title": "On the frontend, after a user logs in via Internet Identity, check whether the user's profile has Admin role and approved status before rendering the 'Access Pending' screen. If the user is the first user (auto-admin), redirect them directly to the dashboard without displaying the Access Pending or approval request UI.",
      "reqIds": [
        "REQ-15"
      ],
      "version": 1
    },
    {
      "id": "feature-on-the-frontend-after-internet-identity-login-completes-and-the-user-profile-is-fetched-check-if-the-profile-has-admin-role-and-approved-status-if-both-conditions-are-true-redirect-immediately-to-the-dashboard-the-access-pending-screen-and-request-approval-flow-must-never-be-shown-to-an-admin-approved-user-this-must-correctly-handle-the-first-user-auto-admin-case-so-they-never-see-the-access-pending-screen",
      "title": "On the frontend, after Internet Identity login completes and the user profile is fetched, check if the profile has Admin role AND Approved status. If both conditions are true, redirect immediately to the dashboard. The 'Access Pending' screen and 'Request Approval' flow must never be shown to an Admin-approved user. This must correctly handle the first-user auto-admin case so they never see the Access Pending screen.",
      "reqIds": [
        "REQ-17"
      ],
      "version": 1
    },
    {
      "id": "feature-fix-the-failed-to-save-profile-please-try-again-error-that-occurs-when-a-user-submits-the-profile-setup-modal-after-logging-in-via-internet-identity-the-usesavecalleruserprofile-mutation-in-usequeries-ts-must-successfully-persist-the-name-and-email-to-the-motoko-backend-ensure-proper-error-handling-and-that-the-modal-closes-and-the-user-proceeds-to-the-dashboard-on-success",
      "title": "Fix the 'Failed to save profile. Please try again.' error that occurs when a user submits the Profile Setup modal after logging in via Internet Identity. The useSaveCallerUserProfile mutation in useQueries.ts must successfully persist the name and email to the Motoko backend. Ensure proper error handling and that the modal closes and the user proceeds to the dashboard on success.",
      "reqIds": [
        "REQ-18"
      ],
      "version": 1
    },
    {
      "id": "feature-update-the-application-s-visual-theme-color-palette-replace-the-current-deep-blue-primary-color-scheme-with-a-rich-emerald-green-and-dark-teal-palette-as-the-primary-brand-colors-while-retaining-white-backgrounds-clean-typography-and-the-existing-card-based-layout-update-css-custom-properties-in-frontend-src-index-css-and-frontend-tailwind-config-js-to-reflect-the-new-color-tokens-for-sidebar-primary-buttons-accents-and-active-states-keep-the-vcrm-logo-and-orange-accent-highlights-unchanged",
      "title": "Update the application's visual theme color palette. Replace the current deep-blue primary color scheme with a rich emerald green and dark teal palette as the primary brand colors, while retaining white backgrounds, clean typography, and the existing card-based layout. Update CSS custom properties in frontend/src/index.css and frontend/tailwind.config.js to reflect the new color tokens for sidebar, primary buttons, accents, and active states. Keep the VCRM logo and orange accent highlights unchanged.",
      "reqIds": [
        "REQ-19"
      ],
      "version": 1
    },
    {
      "id": "feature-fix-the-failed-to-save-profile-please-try-again-error-that-appears-when-a-user-submits-the-profile-setup-modal-welcome-to-vcrm-after-logging-in-via-internet-identity-the-savecalleruserprofile-backend-call-must-succeed-the-modal-must-close-on-success-and-the-user-must-be-redirected-to-the-dashboard-investigate-and-resolve-any-mismatch-between-the-motoko-backend-s-savecalleruserprofile-function-signature-return-type-and-the-frontend-s-usesavecalleruserprofile-mutation-in-usequeries-ts-ensure-error-handling-surfaces-the-real-underlying-error-in-the-console-for-diagnosis",
      "title": "Fix the 'Failed to save profile. Please try again.' error that appears when a user submits the Profile Setup modal (Welcome to VCRM!) after logging in via Internet Identity. The saveCallerUserProfile backend call must succeed, the modal must close on success, and the user must be redirected to the dashboard. Investigate and resolve any mismatch between the Motoko backend's saveCallerUserProfile function signature/return type and the frontend's useSaveCallerUserProfile mutation in useQueries.ts. Ensure error handling surfaces the real underlying error in the console for diagnosis.",
      "reqIds": [
        "REQ-20"
      ],
      "version": 1
    },
    {
      "id": "feature-in-profilesetupmodal-tsx-fix-the-your-session-may-have-expired-please-log-out-and-log-in-again-error-that-appears-when-a-user-submits-the-profile-setup-form-this-error-is-incorrectly-surfaced-when-the-backend-call-fails-due-to-a-stale-or-missing-actor-reference-the-fix-must-1-detect-when-the-actor-is-not-initialized-or-the-identity-has-expired-2-attempt-to-silently-re-initialize-the-actor-before-retrying-the-savecalleruserprofile-call-3-only-show-a-meaningful-inline-error-message-if-the-retry-also-fails-and-4-never-show-the-session-expiry-message-to-a-user-who-has-a-valid-active-internet-identity-session",
      "title": "In ProfileSetupModal.tsx, fix the 'Your session may have expired. Please log out and log in again.' error that appears when a user submits the profile setup form. This error is incorrectly surfaced when the backend call fails due to a stale or missing actor reference. The fix must: (1) detect when the actor is not initialized or the identity has expired, (2) attempt to silently re-initialize the actor before retrying the saveCallerUserProfile call, (3) only show a meaningful inline error message if the retry also fails, and (4) never show the session expiry message to a user who has a valid active Internet Identity session.",
      "reqIds": [
        "REQ-21"
      ],
      "version": 1
    },
    {
      "id": "feature-in-usequeries-ts-update-the-usesavecalleruserprofile-mutation-to-ensure-the-actor-instance-is-freshly-obtained-at-call-time-not-captured-in-a-stale-closure-before-invoking-savecalleruserprofile-on-the-backend-verify-the-actor-is-available-and-the-identity-is-authenticated-if-the-actor-is-null-or-undefined-at-call-time-throw-a-descriptive-error-that-distinguishes-between-actor-not-ready-and-session-expired-so-profilesetupmodal-tsx-can-display-the-correct-message",
      "title": "In useQueries.ts, update the useSaveCallerUserProfile mutation to ensure the actor instance is freshly obtained at call time (not captured in a stale closure). Before invoking saveCallerUserProfile on the backend, verify the actor is available and the identity is authenticated. If the actor is null or undefined at call time, throw a descriptive error that distinguishes between 'actor not ready' and 'session expired', so ProfileSetupModal.tsx can display the correct message.",
      "reqIds": [
        "REQ-22"
      ],
      "version": 1
    },
    {
      "id": "feature-in-profilesetupmodal-tsx-eliminate-the-authentication-failed-please-log-out-and-log-in-again-error-banner-that-appears-when-the-user-submits-the-profile-setup-form-with-a-valid-internet-identity-session-the-modal-must-not-show-any-authentication-error-to-a-user-who-is-actively-authenticated-on-form-submission-if-the-actor-is-null-or-unavailable-silently-wait-for-the-actor-to-be-ready-up-to-a-reasonable-timeout-before-invoking-savecalleruserprofile-if-the-call-still-fails-surface-a-generic-retry-message-never-the-authentication-failed-or-log-out-and-try-again-text-unless-the-identity-is-genuinely-expired",
      "title": "In ProfileSetupModal.tsx, eliminate the 'Authentication failed. Please log out and log in again.' error banner that appears when the user submits the profile setup form with a valid Internet Identity session. The modal must not show any authentication error to a user who is actively authenticated. On form submission, if the actor is null or unavailable, silently wait for the actor to be ready (up to a reasonable timeout) before invoking saveCallerUserProfile. If the call still fails, surface a generic retry message — never the 'Authentication failed' or 'Log out and try again' text — unless the identity is genuinely expired.",
      "reqIds": [
        "REQ-24"
      ],
      "version": 1
    },
    {
      "id": "feature-in-usequeries-ts-fix-the-usesavecalleruserprofile-mutation-so-that-it-obtains-a-fresh-actor-reference-at-call-time-rather-than-relying-on-a-potentially-stale-closure-before-calling-savecalleruserprofile-confirm-the-actor-is-non-null-and-the-identity-is-authenticated-if-the-actor-is-unavailable-throw-an-error-clearly-labeled-actor-not-ready-not-session-expired-so-profilesetupmodal-tsx-can-distinguish-and-handle-it-without-showing-false-authentication-failure-messages",
      "title": "In useQueries.ts, fix the useSaveCallerUserProfile mutation so that it obtains a fresh actor reference at call time rather than relying on a potentially stale closure. Before calling saveCallerUserProfile, confirm the actor is non-null and the identity is authenticated. If the actor is unavailable, throw an error clearly labeled 'actor_not_ready' (not 'session_expired') so ProfileSetupModal.tsx can distinguish and handle it without showing false authentication failure messages.",
      "reqIds": [
        "REQ-25"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-fix-the-usesavecalleruserprofile-mutation-so-that-it-reliably-obtains-a-fresh-non-null-actor-reference-at-the-moment-of-invocation-do-not-rely-on-a-closure-captured-actor-value-that-may-be-stale-before-calling-savecalleruserprofile-on-the-backend-assert-that-the-actor-is-non-null-and-the-identity-is-authenticated-if-the-actor-is-unavailable-at-call-time-throw-a-clearly-labeled-error-e-g-actor-not-ready-distinct-from-any-session-expiry-error-so-the-ui-layer-can-differentiate-the-two-failure-modes",
      "title": "In frontend/src/hooks/useQueries.ts, fix the useSaveCallerUserProfile mutation so that it reliably obtains a fresh, non-null actor reference at the moment of invocation. Do not rely on a closure-captured actor value that may be stale. Before calling saveCallerUserProfile on the backend, assert that the actor is non-null and the identity is authenticated. If the actor is unavailable at call time, throw a clearly labeled error (e.g., 'actor_not_ready') distinct from any session-expiry error, so the UI layer can differentiate the two failure modes.",
      "reqIds": [
        "REQ-27"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-rewrite-the-usesavecalleruserprofile-mutation-so-it-obtains-a-completely-fresh-actor-reference-at-the-exact-moment-of-invocation-using-the-actor-factory-or-context-accessor-never-a-closure-captured-value-before-calling-savecalleruserprofile-assert-the-actor-is-non-null-and-the-identity-is-authenticated-if-the-actor-is-unavailable-throw-a-clearly-labeled-error-code-actor-not-ready-distinct-from-session-expired-and-retry-actor-acquisition-up-to-3-times-with-a-short-delay-before-giving-up",
      "title": "In frontend/src/hooks/useQueries.ts, rewrite the useSaveCallerUserProfile mutation so it obtains a completely fresh actor reference at the exact moment of invocation using the actor factory or context accessor — never a closure-captured value. Before calling saveCallerUserProfile, assert the actor is non-null and the identity is authenticated. If the actor is unavailable, throw a clearly labeled error code 'actor_not_ready' (distinct from 'session_expired') and retry actor acquisition up to 3 times with a short delay before giving up.",
      "reqIds": [
        "REQ-31"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-components-profilesetupmodal-tsx-fix-the-form-submission-handler-so-that-the-unable-to-save-profile-please-try-again-error-no-longer-appears-for-users-with-a-valid-internet-identity-session-on-submission-if-the-actor-is-not-yet-ready-silently-poll-or-wait-up-to-5-seconds-for-it-to-become-available-before-invoking-savecalleruserprofile-on-success-close-the-modal-and-navigate-the-user-to-the-dashboard-if-the-call-fails-after-all-retries-display-only-the-generic-message-unable-to-save-profile-please-try-again-never-display-any-text-referencing-authentication-failure-session-expiry-or-log-out-and-try-again-unless-the-identity-is-genuinely-expired",
      "title": "In frontend/src/components/ProfileSetupModal.tsx, fix the form submission handler so that the 'Unable to save profile. Please try again.' error no longer appears for users with a valid Internet Identity session. On submission, if the actor is not yet ready, silently poll or wait up to 5 seconds for it to become available before invoking saveCallerUserProfile. On success, close the modal and navigate the user to the dashboard. If the call fails after all retries, display only the generic message 'Unable to save profile. Please try again.' — never display any text referencing authentication failure, session expiry, or 'log out and try again' unless the identity is genuinely expired.",
      "reqIds": [
        "REQ-32"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-rewrite-the-usesavecalleruserprofile-mutation-to-obtain-a-completely-fresh-non-null-actor-reference-at-the-exact-moment-of-invocation-never-a-closure-captured-value-before-calling-savecalleruserprofile-assert-the-actor-is-non-null-and-the-identity-is-authenticated-if-the-actor-is-unavailable-retry-acquisition-up-to-3-times-with-a-short-delay-if-still-unavailable-throw-a-clearly-labeled-error-code-actor-not-ready-distinct-from-session-expired-so-the-ui-layer-can-differentiate-the-two-failure-modes",
      "title": "In frontend/src/hooks/useQueries.ts, rewrite the useSaveCallerUserProfile mutation to obtain a completely fresh, non-null actor reference at the exact moment of invocation — never a closure-captured value. Before calling saveCallerUserProfile, assert the actor is non-null and the identity is authenticated. If the actor is unavailable, retry acquisition up to 3 times with a short delay. If still unavailable, throw a clearly labeled error code 'actor_not_ready' (distinct from 'session_expired') so the UI layer can differentiate the two failure modes.",
      "reqIds": [
        "REQ-34"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-components-profilesetupmodal-tsx-fix-the-form-submission-handler-so-the-unable-to-save-profile-please-try-again-error-no-longer-appears-for-users-with-a-valid-internet-identity-session-on-submission-if-the-actor-is-not-yet-ready-silently-poll-or-wait-up-to-5-seconds-for-the-actor-to-become-available-before-invoking-savecalleruserprofile-on-success-close-the-modal-and-navigate-the-user-to-the-dashboard-if-the-call-fails-after-all-retries-display-only-the-generic-message-unable-to-save-profile-please-try-again-never-display-any-text-referencing-authentication-failure-session-expiry-or-log-out-and-try-again-unless-the-identity-is-genuinely-expired",
      "title": "In frontend/src/components/ProfileSetupModal.tsx, fix the form submission handler so the 'Unable to save profile. Please try again.' error no longer appears for users with a valid Internet Identity session. On submission, if the actor is not yet ready, silently poll or wait up to 5 seconds for the actor to become available before invoking saveCallerUserProfile. On success, close the modal and navigate the user to the dashboard. If the call fails after all retries, display only the generic message 'Unable to save profile. Please try again.' — never display any text referencing authentication failure, session expiry, or 'log out and try again' unless the identity is genuinely expired.",
      "reqIds": [
        "REQ-35"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-completely-rewrite-the-usesavecalleruserprofile-mutation-so-it-1-obtains-a-completely-fresh-actor-reference-at-the-exact-moment-of-invocation-by-reading-from-the-actor-context-or-factory-never-a-stale-closure-captured-value-2-before-calling-savecalleruserprofile-asserts-the-actor-is-non-null-and-the-identity-is-authenticated-3-if-the-actor-is-unavailable-retries-actor-acquisition-up-to-3-times-with-a-1-second-delay-between-attempts-4-if-still-unavailable-after-retries-throws-a-clearly-labeled-error-with-code-actor-not-ready-distinct-from-any-session-expiry-error-5-on-success-returns-the-result-so-the-ui-can-proceed",
      "title": "In frontend/src/hooks/useQueries.ts, completely rewrite the useSaveCallerUserProfile mutation so it: (1) obtains a completely fresh actor reference at the exact moment of invocation by reading from the actor context or factory — never a stale closure-captured value; (2) before calling saveCallerUserProfile, asserts the actor is non-null and the identity is authenticated; (3) if the actor is unavailable, retries actor acquisition up to 3 times with a 1-second delay between attempts; (4) if still unavailable after retries, throws a clearly labeled error with code 'actor_not_ready' (distinct from any session-expiry error); (5) on success, returns the result so the UI can proceed.",
      "reqIds": [
        "REQ-37"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-components-profilesetupmodal-tsx-fix-the-form-submission-handler-so-that-the-unable-to-save-profile-please-try-again-error-no-longer-appears-for-users-with-a-valid-internet-identity-session-on-form-submission-1-if-the-actor-is-not-yet-ready-silently-poll-for-the-actor-to-become-available-for-up-to-5-seconds-before-invoking-savecalleruserprofile-2-on-success-close-the-modal-and-navigate-the-user-to-the-dashboard-3-if-the-call-fails-after-all-retries-display-only-the-generic-message-unable-to-save-profile-please-try-again-with-a-retry-button-never-display-any-text-referencing-authentication-failure-session-expiry-or-log-out-and-try-again-unless-the-identity-is-genuinely-expired-i-e-useinternetidentity-reports-no-active-identity",
      "title": "In frontend/src/components/ProfileSetupModal.tsx, fix the form submission handler so that the 'Unable to save profile. Please try again.' error no longer appears for users with a valid Internet Identity session. On form submission: (1) if the actor is not yet ready, silently poll for the actor to become available for up to 5 seconds before invoking saveCallerUserProfile; (2) on success, close the modal and navigate the user to the dashboard; (3) if the call fails after all retries, display only the generic message 'Unable to save profile. Please try again.' with a retry button — never display any text referencing authentication failure, session expiry, or 'log out and try again' unless the identity is genuinely expired (i.e., useInternetIdentity reports no active identity).",
      "reqIds": [
        "REQ-38"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-rewrite-the-usesavecalleruserprofile-mutation-so-it-obtains-a-completely-fresh-non-null-actor-reference-at-the-exact-moment-of-invocation-never-a-stale-closure-captured-value-before-calling-savecalleruserprofile-assert-the-actor-is-non-null-and-the-identity-is-authenticated-if-the-actor-is-unavailable-retry-actor-acquisition-up-to-3-times-with-a-1-second-delay-between-attempts-if-still-unavailable-after-all-retries-throw-a-clearly-labeled-error-with-code-actor-not-ready-distinct-from-session-expired-on-success-return-the-result-so-the-ui-can-proceed",
      "title": "In frontend/src/hooks/useQueries.ts, rewrite the useSaveCallerUserProfile mutation so it obtains a completely fresh, non-null actor reference at the exact moment of invocation — never a stale closure-captured value. Before calling saveCallerUserProfile, assert the actor is non-null and the identity is authenticated. If the actor is unavailable, retry actor acquisition up to 3 times with a 1-second delay between attempts. If still unavailable after all retries, throw a clearly labeled error with code 'actor_not_ready' (distinct from 'session_expired'). On success, return the result so the UI can proceed.",
      "reqIds": [
        "REQ-40"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-components-profilesetupmodal-tsx-fix-the-form-submission-handler-so-that-no-error-message-appears-for-users-with-a-valid-internet-identity-session-on-submission-if-the-actor-is-not-yet-ready-silently-poll-for-the-actor-to-become-available-for-up-to-5-seconds-before-invoking-savecalleruserprofile-on-success-close-the-modal-and-navigate-the-user-to-the-dashboard-if-the-call-fails-after-all-retries-display-only-the-generic-message-unable-to-save-profile-please-try-again-with-a-retry-button-never-display-any-text-referencing-authentication-failure-session-expiry-or-log-out-and-try-again-unless-useinternetidentity-explicitly-reports-no-active-identity",
      "title": "In frontend/src/components/ProfileSetupModal.tsx, fix the form submission handler so that no error message appears for users with a valid Internet Identity session. On submission, if the actor is not yet ready, silently poll for the actor to become available for up to 5 seconds before invoking saveCallerUserProfile. On success, close the modal and navigate the user to the dashboard. If the call fails after all retries, display only the generic message 'Unable to save profile. Please try again.' with a retry button. Never display any text referencing authentication failure, session expiry, or 'log out and try again' unless useInternetIdentity explicitly reports no active identity.",
      "reqIds": [
        "REQ-41"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-perform-a-definitive-rewrite-of-the-usesavecalleruserprofile-mutation-so-that-it-1-obtains-a-completely-fresh-actor-reference-at-the-exact-moment-of-invocation-by-reading-from-the-actor-context-never-a-stale-closure-captured-value-2-if-the-actor-is-unavailable-retries-actor-acquisition-up-to-5-times-with-a-1-second-delay-between-attempts-3-after-all-retries-if-the-actor-is-still-unavailable-throws-an-error-clearly-labeled-actor-not-ready-never-session-expired-so-the-ui-can-differentiate-4-calls-savecalleruserprofile-with-the-correct-parameter-shape-matching-the-updated-backend-signature-5-on-success-returns-the-result-so-the-ui-can-proceed-add-verbose-console-logging-at-each-step-actor-acquired-call-attempted-result-received-to-aid-diagnosis",
      "title": "In frontend/src/hooks/useQueries.ts, perform a definitive rewrite of the useSaveCallerUserProfile mutation so that it: (1) obtains a completely fresh actor reference at the exact moment of invocation by reading from the actor context — never a stale closure-captured value; (2) if the actor is unavailable, retries actor acquisition up to 5 times with a 1-second delay between attempts; (3) after all retries, if the actor is still unavailable, throws an error clearly labeled 'actor_not_ready' (never 'session_expired') so the UI can differentiate; (4) calls saveCallerUserProfile with the correct parameter shape matching the updated backend signature; (5) on success, returns the result so the UI can proceed. Add verbose console logging at each step (actor acquired, call attempted, result received) to aid diagnosis.",
      "reqIds": [
        "REQ-43"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-components-profilesetupmodal-tsx-definitively-fix-the-form-submission-handler-so-that-the-unable-to-save-profile-please-try-again-error-no-longer-appears-for-users-with-a-valid-internet-identity-session-on-form-submission-1-disable-the-submit-button-and-show-a-loading-spinner-while-the-save-is-in-progress-2-if-the-actor-is-not-yet-ready-silently-poll-for-up-to-8-seconds-before-invoking-savecalleruserprofile-3-on-success-close-the-modal-and-navigate-the-user-to-the-dashboard-4-if-the-call-fails-after-all-retries-display-only-the-generic-message-unable-to-save-profile-please-try-again-with-a-try-again-retry-button-never-display-any-text-referencing-authentication-failure-session-expiry-or-log-out-and-try-again-unless-useinternetidentity-explicitly-reports-no-active-identity-ensure-all-error-cases-are-caught-and-the-user-is-never-left-in-a-broken-state",
      "title": "In frontend/src/components/ProfileSetupModal.tsx, definitively fix the form submission handler so that the 'Unable to save profile. Please try again.' error no longer appears for users with a valid Internet Identity session. On form submission: (1) disable the submit button and show a loading spinner while the save is in progress; (2) if the actor is not yet ready, silently poll for up to 8 seconds before invoking saveCallerUserProfile; (3) on success, close the modal and navigate the user to the dashboard; (4) if the call fails after all retries, display only the generic message 'Unable to save profile. Please try again.' with a 'Try again' retry button — never display any text referencing authentication failure, session expiry, or 'log out and try again' unless useInternetIdentity explicitly reports no active identity. Ensure all error cases are caught and the user is never left in a broken state.",
      "reqIds": [
        "REQ-44"
      ],
      "version": 1
    },
    {
      "id": "feature-replace-the-existing-internet-identity-login-page-frontend-src-pages-loginpage-tsx-with-a-professional-otp-based-login-ui-the-page-must-have-two-steps-step-1-an-email-input-field-with-a-send-otp-button-step-2-a-6-digit-otp-input-individual-digit-boxes-or-a-single-input-with-a-verify-otp-countdown-timer-10-minutes-a-resend-otp-link-and-a-verify-button-display-the-generated-otp-inline-simulated-delivery-in-a-highlighted-info-banner-since-real-email-delivery-is-not-available-on-successful-verification-store-the-session-email-verified-status-and-redirect-to-the-dashboard-or-profile-setup-if-the-profile-is-incomplete-apply-the-existing-emerald-green-and-dark-teal-brand-theme-consistently",
      "title": "Replace the existing Internet Identity login page (frontend/src/pages/LoginPage.tsx) with a professional OTP-based login UI. The page must have two steps: Step 1 — an email input field with a 'Send OTP' button; Step 2 — a 6-digit OTP input (individual digit boxes or a single input) with a 'Verify OTP' countdown timer (10 minutes), a 'Resend OTP' link, and a 'Verify' button. Display the generated OTP inline (simulated delivery) in a highlighted info banner since real email delivery is not available. On successful verification, store the session (email + verified status) and redirect to the dashboard or Profile Setup if the profile is incomplete. Apply the existing emerald green and dark teal brand theme consistently.",
      "reqIds": [
        "REQ-46"
      ],
      "version": 1
    },
    {
      "id": "feature-create-a-new-professional-profile-page-at-frontend-src-pages-profilepage-tsx-the-page-must-display-the-logged-in-user-s-profile-information-full-name-email-phone-role-account-status-and-member-since-date-in-a-clean-card-based-layout-include-an-inline-edit-form-or-edit-modal-allowing-the-user-to-update-their-name-email-and-phone-number-show-a-non-editable-section-for-role-and-account-status-add-a-change-password-re-verify-section-with-a-button-that-triggers-a-new-otp-to-the-registered-email-for-re-authentication-apply-the-emerald-green-dark-teal-brand-theme-add-a-route-profile-in-app-tsx-and-a-profile-link-in-the-sidebar-navigation-in-layout-tsx",
      "title": "Create a new professional Profile page at frontend/src/pages/ProfilePage.tsx. The page must display the logged-in user's profile information (full name, email, phone, role, account status, and member since date) in a clean card-based layout. Include an inline edit form (or edit modal) allowing the user to update their name, email, and phone number. Show a non-editable section for role and account status. Add a 'Change Password / Re-verify' section with a button that triggers a new OTP to the registered email for re-authentication. Apply the emerald green / dark teal brand theme. Add a route '/profile' in App.tsx and a 'Profile' link in the sidebar navigation in Layout.tsx.",
      "reqIds": [
        "REQ-48"
      ],
      "version": 1
    },
    {
      "id": "feature-in-frontend-src-hooks-usequeries-ts-add-react-query-hooks-for-the-new-otp-and-profile-endpoints-usegenerateotp-email-useverifyotp-email-otp-usegetcalleruserprofile-and-useupdatecalleruserprofile-ensure-these-hooks-use-a-freshly-obtained-actor-reference-at-call-time-not-a-stale-closure-handle-loading-success-and-error-states-and-invalidate-relevant-queries-on-mutation-success",
      "title": "In frontend/src/hooks/useQueries.ts, add React Query hooks for the new OTP and profile endpoints: useGenerateOTP(email), useVerifyOTP(email, otp), useGetCallerUserProfile, and useUpdateCallerUserProfile. Ensure these hooks use a freshly obtained actor reference at call time (not a stale closure). Handle loading, success, and error states and invalidate relevant queries on mutation success.",
      "reqIds": [
        "REQ-49"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Login & Signup system via Internet Identity",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-2",
      "summary": "Dashboard with total leads, deals, and revenue stats",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-3",
      "summary": "Add/Edit/Delete Leads management",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-4",
      "summary": "Customer management module",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-5",
      "summary": "Follow-up reminders with notifications",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-6",
      "summary": "Deal pipeline with stages: New, In Progress, Won, Lost",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-7",
      "summary": "Search and filter functionality",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-8",
      "summary": "Admin panel",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-9",
      "summary": "Dark and Light mode toggle",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-10",
      "summary": "Solar project management: site survey, system size (kW), installation status, customer location map",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-11",
      "summary": "Fix the user approval flow so that the very first user who logs in via Internet Identity is automatically granted Admin status and full access, bypassing the 'Access Pending' screen. Subsequent users should still go through approval.",
      "reqIds": [
        "REQ-12"
      ],
      "status": "pending"
    },
    {
      "id": "AR-12",
      "summary": "In the Motoko backend, modify the user registration/login logic so that the very first user who authenticates via Internet Identity is automatically assigned the Admin role and approved status, without requiring any manual approval. All subsequent users should continue through the existing approval flow.",
      "reqIds": [
        "REQ-14"
      ],
      "status": "pending"
    },
    {
      "id": "AR-13",
      "summary": "In the Motoko backend, ensure that the very first user who authenticates via Internet Identity is automatically assigned the Admin role and 'approved' status at the moment their profile is created, with no additional approval step required. All subsequent users must continue through the existing manual approval flow.",
      "reqIds": [
        "REQ-16"
      ],
      "status": "pending"
    },
    {
      "id": "AR-14",
      "summary": "Fix errors in the current build and change/update the theme color",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-15",
      "summary": "Fix 'Your session may have expired. Please log out and log in again.' error — handle session expiry gracefully and auto-recover or prompt user to re-authenticate without showing this error unexpectedly.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-18",
      "summary": "In Layout.tsx, handle the case where the actor becomes unavailable mid-session (e.g., after an identity expiry). When any backend query or mutation fails with an authentication-related error, display a non-blocking toast or banner prompting the user to re-authenticate, rather than leaving them stuck on a broken state. Provide a visible 'Log out and log in again' action button in such cases.",
      "reqIds": [
        "REQ-23"
      ],
      "status": "pending"
    },
    {
      "id": "AR-19",
      "summary": "Fix 'Authentication failed. Please log out and log in again.' error and 'Log out and try again' message showing unexpectedly — handle authentication failures gracefully without surfacing this error to users with valid sessions.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-20",
      "summary": "Fix the 'Unable to save profile. Please try again.' error shown in the Profile Setup modal ('Welcome to VCRM!') when a user submits their name and email. The saveCallerUserProfile backend call must succeed for authenticated users. The root cause must be identified and resolved — whether it is a stale actor reference, a mismatch between the Motoko backend function signature and the frontend mutation in useQueries.ts, or an authentication timing issue. On success, the modal must close and the user must proceed to the dashboard without any error banner.",
      "reqIds": [
        "REQ-26"
      ],
      "status": "pending"
    },
    {
      "id": "AR-22",
      "summary": "In frontend/src/components/ProfileSetupModal.tsx, fix the form submission handler so that the 'Unable to save profile. Please try again.' error no longer appears for users with a valid Internet Identity session. On submission, if the actor is not yet ready, silently poll or wait (up to a reasonable timeout, e.g., 5 seconds) for the actor to become available before invoking saveCallerUserProfile. If the call succeeds, close the modal and navigate the user to the dashboard. If the call fails after retry, display a generic user-friendly message (e.g., 'Unable to save profile. Please try again.') without any mention of authentication failure or session expiry unless the identity is genuinely expired.",
      "reqIds": [
        "REQ-28"
      ],
      "status": "pending"
    },
    {
      "id": "AR-23",
      "summary": "In the Motoko backend (backend/main.mo), verify that the saveCallerUserProfile function signature, parameter types, and return type exactly match what the frontend mutation in useQueries.ts expects. Ensure that the function correctly accepts name and email string parameters from the caller, persists the profile, and returns a result or confirmation that the frontend can reliably decode. Fix any type mismatches, optional wrapping issues, or variant mismatches that would cause the frontend Candid decode to fail silently or throw.",
      "reqIds": [
        "REQ-29"
      ],
      "status": "pending"
    },
    {
      "id": "AR-24",
      "summary": "In backend/main.mo, audit and fix the saveCallerUserProfile function to ensure its parameter types (name: Text, email: Text), return type, and Candid encoding exactly match what the frontend expects. Ensure the function correctly persists the profile for the authenticated caller and returns a result the frontend Candid decoder can reliably handle without silent failures or variant mismatches.",
      "reqIds": [
        "REQ-30"
      ],
      "status": "pending"
    },
    {
      "id": "AR-25",
      "summary": "In backend/main.mo, audit and fix the saveCallerUserProfile function so its parameter types (name: Text, email: Text), return type, and Candid encoding exactly match what the frontend mutation in useQueries.ts expects. Ensure the function correctly persists the profile for the authenticated caller and returns a result the frontend Candid decoder can reliably handle without silent failures, optional-wrapping mismatches, or variant mismatches.",
      "reqIds": [
        "REQ-33"
      ],
      "status": "pending"
    },
    {
      "id": "AR-26",
      "summary": "In backend/main.mo, audit and fix the saveCallerUserProfile function to ensure its parameter types (name: Text, email: Text), return type, and Candid encoding are correct and unambiguous. The function must persist the profile for the authenticated caller and return a simple, decodable result (e.g., a plain variant or unit type) that the frontend Candid decoder can handle without silent failures, optional-wrapping mismatches, or variant decode errors. Remove any overloads or conflicting type definitions that could cause a mismatch.",
      "reqIds": [
        "REQ-36"
      ],
      "status": "pending"
    },
    {
      "id": "AR-27",
      "summary": "In backend/main.mo, audit and fix the saveCallerUserProfile function to ensure its parameter types (name: Text, email: Text), return type, and Candid encoding exactly match what the frontend mutation in useQueries.ts expects. The function must correctly persist the profile for the authenticated caller and return a simple, unambiguous, decodable result (e.g., a plain variant or unit type) that the frontend Candid decoder can handle without silent failures, optional-wrapping mismatches, or variant decode errors. Remove any conflicting type definitions or overloads.",
      "reqIds": [
        "REQ-39"
      ],
      "status": "pending"
    },
    {
      "id": "AR-28",
      "summary": "In backend/main.mo, perform a definitive audit and fix of the saveCallerUserProfile function. Ensure its parameter types (name: Text, email: Text), return type, and Candid encoding are completely correct and match exactly what the frontend expects. The function must: (1) accept name and email as plain Text parameters from the authenticated caller, (2) correctly persist the profile and assign the first-user auto-admin role if applicable, (3) return a simple, unambiguous result type (e.g., a plain variant #ok or #err Text, or unit) that the frontend Candid decoder can handle without silent failures, optional-wrapping mismatches, or variant decode errors. Remove any conflicting type definitions, overloads, or duplicate function signatures that could cause a Candid mismatch.",
      "reqIds": [
        "REQ-42"
      ],
      "status": "pending"
    },
    {
      "id": "AR-29",
      "summary": "Replace Internet Identity login with OTP-based login system (email/phone OTP authentication) and build a professional Profile page for users to view and edit their profile information.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-30",
      "summary": "In the Motoko backend (backend/main.mo), implement an OTP (One-Time Password) authentication system. Add functions to: (1) generateOTP(email: Text) — generate a 6-digit numeric OTP, store it against the email with a 10-minute expiry timestamp, and return the OTP (the frontend will display/simulate delivery since email sending is not supported); (2) verifyOTP(email: Text, otp: Text) — validate the OTP against the stored value and expiry, return a result indicating success or failure with a reason; (3) on successful OTP verification, look up or create a user profile keyed by the verified email, applying the existing first-user auto-admin logic. Remove or retain Internet Identity as a secondary option but OTP must be the primary login path.",
      "reqIds": [
        "REQ-45"
      ],
      "status": "pending"
    },
    {
      "id": "AR-32",
      "summary": "In the Motoko backend (backend/main.mo), add or update user profile management functions to support a richer profile: (1) getCallerUserProfile — return the authenticated caller's profile including name, email, phone (optional), role, approvalStatus, and joinDate; (2) updateCallerUserProfile(name: Text, email: Text, phone: Text) — update the caller's profile fields and return a result. Ensure these functions are compatible with the OTP-based session (keyed by email principal or stored identity).",
      "reqIds": [
        "REQ-47"
      ],
      "status": "pending"
    }
  ],
  "gameProjectType": "none",
  "projectName": "VCRM",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}